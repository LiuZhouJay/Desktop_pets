#include "app_oled.h"

int x ,x_trg;
int y  = 18,y_trg = 18;

int frame_len,frame_len_trg;//框框的宽度
int frame_y,frame_y_trg;//框框的y

int ui_select = 0;

extern char mqtt_data[100];

extern key_state_t g_key[2]; 
extern char *weather_data;
extern char *temperature_data;
extern SemaphoreHandle_t key_read_semaphore;

SETTING_LIST list[] = 
{
  {"list",4},
  {"ab",2},
  {"abc",3},
  {"abcd",4},
};
unsigned char love_heart[518] = {
    0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0x07,0x00,0x00,
    0x00,0x00,0xFC,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
    0x00,0x80,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0x07,0x00,
    0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,
    0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x00,0xFE,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,
    0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x80,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x01,
    0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0xE0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07,
    0xE0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x07,0xF0,0xFF,0xDF,0xFF,0xFF,0xC3,0xFF,0x0F,
    0xF8,0xFF,0x01,0xFC,0x7F,0x00,0xFE,0x1F,0xF8,0xFF,0x00,0xF0,0x3F,0x00,0xFC,0x1F,
    0xFC,0x3F,0x00,0xE0,0x1F,0x00,0xF8,0x3F,0xFC,0x3F,0x00,0xC0,0x0F,0x00,0xF0,0x3F,
    0xFC,0x1F,0x00,0x80,0x07,0x00,0xE0,0x3F,0xFE,0x1F,0x00,0x80,0x03,0x00,0xE0,0x7F,
    0xFE,0x0F,0x00,0x00,0x01,0x00,0xE0,0x7F,0xFE,0x0F,0x00,0x00,0x00,0x00,0xE0,0x7F,
    0xFF,0x0F,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,0xC0,0xFF,
    0xFF,0x1F,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0xE0,0xFF,
    0xFF,0x1F,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0xE0,0xFF,
    0xFF,0x3F,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,0xF8,0xFF,
    0xFF,0xFF,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0x01,0x00,0x00,0x00,0xFC,0xFF,
    0xFF,0xFF,0x01,0x00,0x00,0x00,0xFE,0xFF,0xFF,0xFF,0x03,0x00,0x00,0x00,0xFF,0xFF,
    0xFF,0xFF,0x07,0x00,0x00,0x80,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,0x00,0xC0,0xFF,0xFF,
    0xFF,0xFF,0x1F,0x00,0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x00,0xF0,0xFF,0xFF,
    0xFE,0xFF,0xFF,0x00,0x00,0xF8,0xFF,0x7F,0xFE,0xFF,0xFF,0x01,0x00,0xFC,0xFF,0x7F,
    0xFE,0xFF,0xFF,0x03,0x00,0xFE,0xFF,0x7F,0xFC,0xFF,0xFF,0x03,0x00,0xFF,0xFF,0x3F,
    0xFC,0xFF,0xFF,0x07,0x80,0xFF,0xFF,0x3F,0xFC,0xFF,0xFF,0x0F,0xC0,0xFF,0xFF,0x3F,
    0xF8,0xFF,0xFF,0x1F,0xC0,0xFF,0xFF,0x1F,0xF8,0xFF,0xFF,0x3F,0xE0,0xFF,0xFF,0x1F,
    0xF0,0xFF,0xFF,0x7F,0xF0,0xFF,0xFF,0x0F,0xE0,0xFF,0xFF,0x7F,0xF8,0xFF,0xFF,0x07,
    0xE0,0xFF,0xFF,0xFF,0xFC,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0xFF,0xFC,0xFF,0xFF,0x03,
    0x80,0xFF,0xFF,0xFF,0xFD,0xFF,0xFF,0x01,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
    0x00,0xFE,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
    0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,
    0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0x07,0x00,0x00,0x80,0xFF,0xFF,0xFF,0xFF,0x01,0x00,
    0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0x3F,0x00,0x00,
    0x00,0x00,0xE0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
};

unsigned char taiji[1024] = {
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xC9,0xDB,0xFF,0xFF,0xFF,0xFF,0xFF,0xBF,0xFF,0xFF,0xFE,0xFF,0xFF,
    0xFF,0xFF,0xEF,0xFF,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xF9,0xFF,0x4B,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xBF,0x79,0xFF,0xFF,0xFF,0xBF,0xFF,0xFF,0x5F,0xFC,0xFE,0xFF,
    0xFF,0xDF,0xFF,0xFF,0x3F,0xE5,0xFD,0xFF,0xFF,0xEF,0xFF,0xFF,0xFF,0x82,0xF7,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0x3A,0xFE,0xFF,0xFF,0xFB,0xFF,0xFF,0xFF,0x81,0xDF,0xFF,
    0xFF,0xFD,0xFF,0xFF,0xFF,0x4B,0xBA,0xFF,0xFF,0xFE,0xFF,0xFF,0xFF,0x25,0xB5,0xFF,
    0x7F,0xFF,0xFF,0xFF,0xFF,0xB3,0x65,0xFF,0xFF,0xFF,0xFF,0xEB,0xFF,0x2B,0xC9,0xFE,
    0xBF,0xFF,0xFF,0x9B,0xFF,0x87,0xD4,0xFF,0xFF,0xFF,0xFF,0xD7,0xFF,0xC7,0xC0,0xFD,
    0xDF,0xFF,0xFF,0x91,0xFF,0x7B,0xEB,0xFF,0xFF,0xFF,0xFF,0xEF,0xFF,0x13,0x94,0xFB,
    0xEF,0xFF,0xFF,0xF7,0xFF,0xC7,0x3D,0xFB,0xFF,0xFF,0xFF,0xFF,0xFF,0x6D,0x4A,0xF7,
    0xF7,0xFF,0xFF,0xFF,0xFF,0x91,0x00,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0x15,0x00,0xF6,
    0xF7,0xFF,0xFF,0xFF,0xFF,0x52,0x00,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0x69,0x00,0xFD,
    0xFF,0xFF,0xFF,0xFF,0xFF,0x84,0x00,0xEC,0xFF,0xFF,0xFF,0xFF,0x5F,0x93,0x00,0xFE,
    0xFB,0xFF,0xFF,0xFF,0x8F,0x42,0x00,0xFD,0xFF,0xFF,0xFF,0xFF,0x1B,0x98,0x00,0xEC,
    0xFF,0xFF,0xFF,0xFF,0x0D,0x00,0x00,0xFE,0xFB,0xFF,0xFF,0xFF,0x10,0x00,0x00,0xEC,
    0xFB,0xFF,0xFF,0x7F,0x6B,0x00,0x00,0xEC,0xFF,0xFF,0xFF,0xBF,0x84,0x00,0x00,0xFE,
    0xFF,0xFF,0xFF,0x67,0x77,0x00,0x00,0xEE,0xF7,0xFF,0xFF,0x5B,0x48,0x00,0x00,0xED,
    0xFF,0xFF,0xFF,0xA7,0xA1,0x00,0x00,0xFF,0xF7,0xFF,0xFF,0x09,0x74,0x00,0x00,0xF6,
    0xFF,0xFF,0xFF,0x34,0xA6,0x00,0xDA,0xF6,0xEF,0xFF,0xFF,0xCA,0x49,0x00,0x2E,0xFF,
    0xFF,0xFF,0xFF,0x29,0xDC,0x00,0xE1,0xFB,0xFF,0xFF,0xFF,0x34,0xFF,0x00,0x0A,0xFF,
    0xDF,0xFF,0x7F,0x5B,0x7F,0x00,0xB1,0xFF,0xFF,0xFF,0x7F,0xB1,0xFF,0x00,0xE4,0xFD,
    0xBF,0xFF,0x7F,0xA4,0x7F,0x00,0xE9,0xFF,0xFF,0xFF,0x7F,0xDA,0xFF,0x00,0xD4,0xFE,
    0xFF,0xFF,0xFF,0xAA,0xBF,0xB2,0x6A,0xFF,0xFF,0xFF,0xFF,0x10,0x5C,0x49,0xBD,0xFF,
    0xFF,0xFD,0xFF,0xB2,0x67,0xB2,0xFE,0xFF,0xFF,0xFF,0xFF,0x15,0x88,0x91,0xFF,0xFF,
    0xFF,0xFF,0xFF,0x29,0x93,0x24,0xFF,0xFF,0xFF,0xE7,0xFF,0x23,0x68,0x2B,0xF7,0xFF,
    0xFF,0xFF,0xFF,0x2F,0xD6,0xC8,0xFB,0xFF,0xFF,0xBF,0xFF,0xCF,0x2D,0xFA,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xBF,0x8A,0xFE,0xFF,0xFF,0xFF,0xFF,0xFD,0xFF,0xB3,0xDF,0xFF,0xFF,
    0xFF,0xFF,0xF7,0xFF,0xFF,0xEF,0xFF,0xFF,0xFF,0xFF,0x9F,0xFF,0xFF,0xFC,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFE,0xC7,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x5F,0xFE,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
};
void draw_progress_bar(u8g2_t *u8g2)
{
    u8g2_FirstPage(u8g2); // 进度条完
    do
    {
        for (uint8_t i = 0; i <= 99; i = i + 1)
        {
            u8g2_ClearBuffer(u8g2);

            char buff[20];
            u8g2_SetFont(u8g2, u8g2_font_ncenB08_tf); // 字体
            sprintf(buff, "%d%%", (int)(i / 100.0 * 100));
            u8g2_DrawStr(u8g2, 105, 49, buff); // 当前进度显示
            u8g2_DrawStr(u8g2, 0, 10, "Lylz");
            u8g2_DrawBox(u8g2, 2, 40, i, 10);     // 填充框实心矩形框
            u8g2_DrawFrame(u8g2, 0, 38, 103, 14); // 空心矩形框

            vTaskDelay(10 / portTICK_PERIOD_MS);
            u8g2_SendBuffer(u8g2);
        }
    } while (u8g2_NextPage(u8g2));
}

int ui_run(int *a,int *a_trg,uint8_t step,uint8_t slow_cnt)
{  
    uint8_t temp;

    temp = abs(*a_trg-*a) > slow_cnt ? step : 1;
    if(*a < *a_trg)
    {
        *a += temp;
    }
    else if( *a > *a_trg)
    {
        *a -= temp;  
    }
    else
    {
        return 0;
    }
    return 1;
}
void ui_show(u8g2_t u8g2)
{
  int list_len = sizeof(list) / sizeof(SETTING_LIST);
    u8g2_ClearBuffer(&u8g2);         // 清除内部缓冲区
    for(int i = 0 ;i < list_len;i++)
    {
        u8g2_DrawStr(&u8g2,x+2,y+i*20,list[0].str);  // 第一段输出位置
    }
    u8g2_DrawRFrame(&u8g2,x,frame_y,frame_len,22,3);
    ui_run(&frame_y,&frame_y_trg,5,4);
    ui_run(&frame_len,&frame_len_trg,10,5);
    u8g2_SendBuffer(&u8g2);          // transfer internal memory to the displa
}


void ui_proc(void)
{
    int list_len = sizeof(list) / sizeof(SETTING_LIST);

    xSemaphoreTake(key_read_semaphore, (TickType_t)portMAX_DELAY);
    if(g_key[0].short_flag)
    {
        g_key[0].short_flag = 0;
        ui_select++;
        if(ui_select >= list_len)
        {
            ui_select = list_len - 1;  
        }
    }
    if(g_key[1].short_flag)
    {
        g_key[1].short_flag = 0;
        ui_select--;
        if(ui_select < 0)
        {
            ui_select = 0;  
        }
    }
        frame_y_trg = ui_select*20;
        frame_len_trg = list[ui_select].len*13;
}


static void oled_task(void *arg)
{
    u8g2_t u8g2;
    u8g2Init(&u8g2);
    u8g2_SetFont(&u8g2,u8g2_font_t0_22_mf);
    while(1){
        ui_proc();
        ui_show(u8g2);
    	vTaskDelay(50 / portTICK_PERIOD_MS);
    }   
}

void app_oled_init(void)
{
    frame_len = frame_len_trg = list[ui_select].len*13;
    xTaskCreate(oled_task, "oled_task", 2048, NULL, 10, NULL);
}




// vTaskDelay(10 / portTICK_PERIOD_MS);
    // u8g2_DrawXBMP(&u8g2,20,0,64,64,love_heart);
    // u8g2_SetFont(&u8g2,u8g2_font_helvR08_tr);

    // u8g2_SetFont(&u8g2,u8g2_font_wqy12_t_gb2312);
    // u8g2_DrawButtonUTF8(&u8g2,62, 20, U8G2_BTN_BW2, 0, 2, 2, weather_data );

    // u8g2_SetFont(&u8g2,u8g2_font_wqy14_t_gb2312);
    // u8g2_DrawUTF8(&u8g2, 0, 20, weather_data);

    // u8g2_SetFont(&u8g2,u8g2_font_wqy16_t_gb2312);
    // u8g2_DrawUTF8(&u8g2, 30, 20, weather_data);

    // u8g2_SetFont(&u8g2,u8g2_font_px437wyse700a_mf);  //显示数字可以，比较大、粗
    // u8g2_DrawButtonUTF8(&u8g2,62, 40, U8G2_BTN_BW2, 0, 2, 2, temperature_data );
    // u8g2_DrawStr(&u8g2, 0, 40, mqtt_data);

    // u8g2_font_helvR08_tr

    // u8g2_SetFont(&u8g2,u8g2_font_ncenB14_tr);
    // static int status = 0;
    // if(g_key[0].two_flag == 1 || g_key[0].long_flag == 1)
    // {
    //      g_key[0].two_flag = 0;
    //      g_key[0].long_flag = 0;
    //     if(status == 1)
    //     {
    //         status = 0;
    //     }
    //     else{

    //         status = 1;
    //     }
    // }
    // if(status == 1)
    // {
    //     u8g2_DrawXBMP(&u8g2,32,0,64,64,love_heart);

    // }
    // else
    // {
    //     u8g2_DrawXBMP(&u8g2,32,0,64,64,taiji);
    // }

    // u8g2_SendBuffer(&u8g2);